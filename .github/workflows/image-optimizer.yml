# .github/workflows/image-optimizer.yml

name: Process Bundle Images to AVIF

on:
  push:
    branches:
      - main
    paths:
      - 'content/posts/**'

jobs:
  build:
    name: Process Bundle Images Job
    runs-on: ubuntu-latest

    steps:
      # 步骤1：检出代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 步骤2：安装 Sharp-CLI 工具
      - name: Install Sharp-CLI
        run: npm install -g sharp-cli

      # 步骤3：核心处理脚本 (使用正确的 Sharp-CLI 语法)
      - name: Find, Process, and Cleanup Images
        run: |
          echo "Starting image processing..."
          find content/posts -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -print0 | while IFS= read -r -d $'\0' file; do
            dir=$(dirname "$file")
            filename=$(basename "$file")
            base="${filename%.*}"
            
            echo "Found source image: $file"
            
            avif_output="${dir}/${base}.avif"
            echo "Target AVIF path: $avif_output"

            # --- 已修正和优化的 Sharp-CLI 命令 ---
            sharp "$file" \
              resize 1600 --without-enlargement \
              avif --quality 50 \
              toFile "$avif_output"

            # --- 检查是否成功，然后删除原图 ---
            if [ $? -eq 0 ]; then
              echo "Successfully created AVIF. Deleting original: $file"
              rm "$file"
            else
              echo "ERROR: Failed to process $file. Halting workflow to prevent data loss."
              exit 1
            fi
            echo "---------------------------------"
          done
          echo "Image processing finished."

      # 步骤4：自动提交所有变更
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'build(media): Process bundle images to AVIF and remove source'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
