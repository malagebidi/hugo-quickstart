# æ–‡ä»¶è·¯å¾„: .github/workflows/image-optimizer.yml

name: 'ğŸ¤– Optimize Bundle Images with ShortPixel'

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€äº‹ä»¶
    paths:
      # åªåœ¨è¿™äº›ç±»å‹çš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘
      - 'content/**/*.jpg'
      - 'content/**/*.png'
      - 'content/**/*.jpeg'

jobs:
  build:
    name: Convert Images Job
    runs-on: ubuntu-latest
    
    # æˆäºˆå·¥ä½œæµå†™å…¥ä»£ç åº“çš„æƒé™
    permissions:
      contents: write
      
    # é˜²æ­¢æœºå™¨äººè‡ªå·±è§¦å‘è‡ªå·±ï¼Œé€ æˆæ— é™å¾ªç¯
    if: github.event.pusher.name != 'GitHub Actions Bot' && github.event.pusher.name != 'github-actions[bot]'

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: 'â¬‡ï¸ Checkout Code'
        uses: actions/checkout@v4
        with:
          # ã€ä¿®å¤å…³é”®ç‚¹1ã€‘æ˜ç¡®æ£€å‡ºåˆ†æ”¯ï¼Œå¹¶è·å–å®Œæ•´å†å²è®°å½•ï¼Œä¸º rebase åšå‡†å¤‡
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      # æ­¥éª¤ 2: å®‰è£…å¿…è¦çš„å·¥å…·
      - name: 'ğŸ”§ Install Dependencies (ImageMagick & jq)'
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick jq
      
      # æ­¥éª¤ 3: æ ¸å¿ƒå¤„ç†é€»è¾‘
      - name: 'ğŸ”„ Find, Process, and Replace Images'
        env:
          SHORTPIXEL_KEY: ${{ secrets.SHORTPIXEL_KEY }} # ä» GitHub Secrets æ³¨å…¥ API Key
        run: |
          echo "ğŸ” Finding new or modified images..."
          # ä½¿ç”¨ git diff-tree æ‰¾å‡ºæœ¬æ¬¡æ¨é€ä¸­æ–°å¢(A)æˆ–ä¿®æ”¹(M)çš„å›¾ç‰‡
          # -r é€’å½’, --no-commit-id éšè—commit id, --name-only åªæ˜¾ç¤ºæ–‡ä»¶å, -z ä½¿ç”¨NULä½œä¸ºåˆ†éš”ç¬¦
          # HEAD~1 è¡¨ç¤ºä¸ä¸Šä¸€ä¸ª commit æ¯”è¾ƒ
          MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r -z HEAD~1 HEAD -- 'content/**/*.jpg' 'content/**/*.png' 'content/**/*.jpeg' | xargs -0)

          if [ -z "$MODIFIED_FILES" ]; then
            echo "âœ… No new or modified images found to process. Exiting."
            exit 0
          fi

          echo "ğŸš€ Processing the following files:"
          echo "$MODIFIED_FILES"

          # å°†æ–‡ä»¶åˆ—è¡¨è½¬æ¢ä¸º JSON æ•°ç»„æ ¼å¼ï¼Œç”¨äº API è¯·æ±‚
          URLS_JSON=$(echo "$MODIFIED_FILES" | jq -R . | jq -s 'map("https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/" + .)')
          
          echo "Building JSON payload..."
          JSON_PAYLOAD=$(jq -n --arg key "$SHORTPIXEL_KEY" --argjson urls "$URLS_JSON" '{
            key: $key,
            plugin_version: "GHA25",
            lossy: 2,         # Glossy (é«˜è´¨é‡æœ‰æŸ)
            wait: 30,         # API ç­‰å¾…æ—¶é—´
            resize: 0,        # ä¸è°ƒæ•´å°ºå¯¸ï¼Œä¿æŒåŸå›¾å¤§å°
            convertto: "avif",# ç›´æ¥è½¬æ¢ä¸º AVIF æ ¼å¼
            urllist: $urls
          }')

          echo "ğŸ“ Calling ShortPixel API..."
          API_RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" https://api.shortpixel.com/v2/reducer.php)

          # æ£€æŸ¥ API æ˜¯å¦è¿”å›äº†é”™è¯¯
          if echo "$API_RESPONSE" | jq -e '.[0].Status.Code == "-2"' > /dev/null; then
              echo "âŒ ERROR: ShortPixel API returned an error."
              echo "$API_RESPONSE" | jq
              exit 1
          fi

          echo "âœ… API call successful. Processing results..."
          echo "$API_RESPONSE" | jq -c '.[]' | while read -r item; do
            original_url=$(echo "$item" | jq -r .OriginalURL)
            avif_url=$(echo "$item" | jq -r .AVIFURL)
            
            # ä» URL ä¸­æå–æœ¬åœ°æ–‡ä»¶è·¯å¾„
            original_path=$(echo "$original_url" | sed "s|https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/||")
            
            if [ -z "$original_path" ]; then
                echo "âš ï¸ Could not extract path for $original_url. Skipping."
                continue
            fi
            
            # è·å–å›¾ç‰‡ç›®å½•å’ŒåŸºæœ¬æ–‡ä»¶å
            dir_path=$(dirname "$original_path")
            base_name=$(basename "$original_path" | sed 's/\.[^.]*$//')
            avif_path="$dir_path/$base_name.avif"

            echo "    - Downloading AVIF for $original_path -> $avif_path"
            curl -s -o "$avif_path" "$avif_url"

            # è·å–åŸå§‹å°ºå¯¸å¹¶å†™å…¥ YAML æ–‡ä»¶ (å¦‚æœå­˜åœ¨)
            if [ -f "$original_path" ]; then
              dimensions=$(identify -format "%wx%h" "$original_path")
              yaml_file="$dir_path/.image_dimensions.yaml"
              
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
              touch "$yaml_file"
              
              # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ›´æ–° YAMLï¼Œé¿å…é‡å¤æ¡ç›® (è™½ç„¶åœ¨è¿™ä¸ªå·¥ä½œæµä¸­ä¸å¤ªå¯èƒ½å‘ç”Ÿ)
              if grep -q "${base_name}:" "$yaml_file"; then
                # å¦‚æœæ¡ç›®å·²å­˜åœ¨, æ›´æ–°å®ƒ (ä½¿ç”¨ sed)
                sed -i "s|${base_name}:.*|${base_name}: ${dimensions}|" "$yaml_file"
              else
                # å¦‚æœæ¡ç›®ä¸å­˜åœ¨, è¿½åŠ 
                echo "${base_name}: ${dimensions}" >> "$yaml_file"
              fi
              echo "    - Saved dimensions (${dimensions}) to ${yaml_file}"

              echo "    - Removing original file: $original_path"
              rm "$original_path"
            else
              echo "    - Warning: Original file $original_path not found locally. Cannot get dimensions or remove."
            fi
          done

          echo "ğŸ‰ Image processing complete."

      # æ­¥éª¤ 4: ä¸è¿œç¨‹åŒæ­¥ï¼Œé˜²æ­¢ non-fast-forward é”™è¯¯
      - name: 'ğŸ”„ Synchronize changes before committing'
        run: |
          # å¿…é¡»å…ˆé…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'
          
          # ã€ä¿®å¤å…³é”®ç‚¹2ã€‘æ‹‰å–è¿œç¨‹åˆ†æ”¯çš„æœ€æ–°æ›´æ”¹å¹¶å˜åŸº
          # è¿™ä¼šå°†æœ¬åœ°æäº¤(å›¾ç‰‡è½¬æ¢)åº”ç”¨åˆ°è¿œç¨‹æœ€æ–°ä»£ç çš„é¡¶éƒ¨
          git pull --rebase
          
      # æ­¥éª¤ 5: æäº¤å¹¶æ¨é€æ‰€æœ‰æ›´æ”¹ (åŒ…æ‹¬ AVIF, YAML, å’Œè¢«åˆ é™¤çš„åŸå›¾)
      - name: 'ğŸš€ Commit and Push Changes'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'build(media): Convert bundle images to AVIF via ShortPixel'
          # å¯é€‰: å¦‚æœå¸Œæœ› commit ä½œè€…æ˜¯ä½ è‡ªå·±
          commit_author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>

