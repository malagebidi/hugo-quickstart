# .github/workflows/image-optimizer.yml
name: 'ğŸ¤– Optimize Bundle Images with ShortPixel'

on:
  push:
    branches:
      - main
    paths:
      - 'content/**/*.jpg'
      - 'content/**/*.png' 
      - 'content/**/*.jpeg'

jobs:
  build:
    name: Convert Images Job
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # é˜²æ­¢æœºå™¨äººæ¨é€å†æ¬¡è§¦å‘å·¥ä½œæµï¼Œå¯¼è‡´æ— é™å¾ªç¯
    if: github.event.pusher.name != 'GitHub Actions Bot' && github.event.pusher.name != 'github-actions[bot]'

    steps:
      - name: 'â¬‡ï¸ Checkout Code'
        uses: actions/checkout@v4
        with:
          # éœ€è¦å®Œæ•´å†å²æ¥æ¯”è¾ƒæœ€è¿‘çš„ä¸¤æ¬¡æäº¤
          fetch-depth: 0 
      
      - name: 'ğŸ”§ Install Dependencies (ImageMagick & jq)'
        # æˆ‘ä»¬ä¸å†éœ€è¦ avifencï¼Œä½†ä»ç„¶éœ€è¦ imagemagick å’Œ jq
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick jq

      - name: 'ğŸ”„ Find, Process, and Replace Images'
        env:
          SHORTPIXEL_KEY: ${{ secrets.SHORTPIXEL_KEY }} # å…³é”®ï¼šç¡®ä¿ä½ å·²ç»åœ¨ä»“åº“ Secrets ä¸­è®¾ç½®äº†æ­¤é¡¹
        run: |
          echo "ğŸ” Finding new or modified images from this push..."
          
          # 1. åªè·å–æœ¬æ¬¡ push ä¸­è¢«æ·»åŠ (A)æˆ–ä¿®æ”¹(M)çš„å›¾ç‰‡æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only --diff-filter=AM ${{ github.event.before }} ${{ github.event.after }} | grep -E '^content/.*\.(jpg|jpeg|png)$' || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "âœ… No new or modified images to process. Exiting."
            exit 0
          fi

          echo "Found images to process:"
          echo "$CHANGED_FILES"
          echo "---------------------------------"

          # 2. å‡†å¤‡å°ºå¯¸æ•°æ®å¹¶æ„å»º API è¯·æ±‚çš„ URL åˆ—è¡¨
          URL_LIST=""
          for file in $CHANGED_FILES; do
            dir=$(dirname "$file")
            filename=$(basename "$file")
            base="${filename%.*}"
            
            # --- ä½ çš„åŸå§‹é€»è¾‘ï¼šè·å–å¹¶ä¿å­˜å°ºå¯¸ ---
            dimensions=$(identify -format "%wx%h" "$file")
            width=$(echo $dimensions | cut -d'x' -f1)
            height=$(echo $dimensions | cut -d'x' -f2)
            dimensions_file="${dir}/.image_dimensions.yaml"
            echo "  - Processing $file (${width}x${height})"

            if [ ! -f "$dimensions_file" ]; then
              echo "# Image Dimensions Data - Auto-generated by GitHub Actions" > "$dimensions_file"
              echo "dimensions:" >> "$dimensions_file"
            fi
            
            # ä½¿ç”¨æ›´å®‰å…¨çš„ YML æ ¼å¼è¿½åŠ ï¼Œé¿å…é‡å¤æ¡ç›® (å…ˆåˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ¡ç›®, å†æ·»åŠ æ–°æ¡ç›®)
            if grep -q "\"${base}\":" "$dimensions_file"; then
              sed -i "/\"${base}\":/,/height:/d" "$dimensions_file"
            fi
            echo "  \"${base}\":" >> "$dimensions_file"
            echo "    width: $width" >> "$dimensions_file"
            echo "    height: $height" >> "$dimensions_file"
            # --- å°ºå¯¸é€»è¾‘ç»“æŸ ---

            # æ„å»º GitHub Raw URL å¹¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­
            RAW_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/$file"
            URL_LIST+="\"$RAW_URL\","
          done

          # ç§»é™¤æœ€åä¸€ä¸ªé€—å·ï¼Œå¹¶ç”¨æ–¹æ‹¬å·åŒ…è£¹ï¼Œå½¢æˆåˆæ³•çš„ JSON æ•°ç»„
          URLS_JSON="[${URL_LIST%,}]"
          echo "ğŸš€ Sending image list to ShortPixel API..."

          # 3. ä¸€æ¬¡æ€§è°ƒç”¨ ShortPixel API
          JSON_PAYLOAD=$(cat <<EOF
{
  "key": "$SHORTPIXEL_KEY",
  "plugin_version": "GHA24",
  "lossy": 1,
  "wait": 30,
  "resize": 1,
  "resize_width": 1920,
  "convertto": "+avif",
  "urllist": $URLS_JSON
}
EOF
          )
          
          API_RESPONSE=$(curl -s -X POST "https://api.shortpixel.com/v2/reducer.php" -H "Content-Type: application/json" -d "$JSON_PAYLOAD")

          # 4. è§£æå“åº”å¹¶ä¸‹è½½ä¼˜åŒ–åçš„å›¾ç‰‡
          echo "ğŸ“¥ Processing API response and downloading files..."
          echo "$API_RESPONSE" | jq -c '.[]' | while read -r item; do
             STATUS=$(echo "$item" | jq -r '.Status.Code')
             ORIGINAL_URL=$(echo "$item" | jq -r '.OriginalURL')
             
             # ä» URL åå‘æ‰¾åˆ°æœ¬åœ°æ–‡ä»¶è·¯å¾„
             LOCAL_FILE=$(echo "$ORIGINAL_URL" | sed "s|https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/||")
             
             if [[ "$STATUS" == "2" ]]; then
                AVIF_URL=$(echo "$item" | jq -r '.AVIFLossyURL')
                dir=$(dirname "$LOCAL_FILE")
                base=$(basename "$LOCAL_FILE" | sed 's/\.[^.]*$//')
                avif_output="${dir}/${base}.avif"

                echo "  - SUCCESS for $LOCAL_FILE. Downloading AVIF..."
                curl -s -L "$AVIF_URL" -o "$avif_output"
                
                # ä¸‹è½½æˆåŠŸåï¼Œåˆ é™¤åŸå›¾
                echo "  - Deleting original: $LOCAL_FILE"
                rm "$LOCAL_FILE"
             else
                MESSAGE=$(echo "$item" | jq -r '.Status.Message')
                echo "  - âŒ ERROR for $LOCAL_FILE: $MESSAGE (Code: $STATUS)"
             fi
          done

          echo "âœ… Image processing complete."

      - name: 'ğŸš€ Commit and Push Changes'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'build(media): Convert bundle images to AVIF via ShortPixel'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions-bot@users.noreply.github.com'
