{{/*
  File: layouts/shortcodes/image.html
  Version: Reads dimensions from hidden .image_dimensions.yaml file
*/}}
{{ $src := .Get "src" }}
{{ $alt := .Get "alt" | default $src }}
{{ $class := .Get "class" }}
{{ $avifPath := printf "%s.avif" $src }}
{{ $avifResource := .Page.Resources.GetMatch $avifPath }}

{{/* Try to get dimensions from hidden dimensions file */}}
{{ $width := "" }}
{{ $height := "" }}
{{ $dimensionsFound := false }}

{{/* Construct path to dimensions file */}}
{{ $pagePath := .Page.File.Dir }}
{{ $dimensionsFilePath := printf "content/%s.image_dimensions.yaml" $pagePath }}

{{/* Try to read the dimensions file */}}
{{ if fileExists $dimensionsFilePath }}
  {{ $dimensionsContent := readFile $dimensionsFilePath }}
  {{ $dimensionsData := $dimensionsContent | transform.Unmarshal }}
  {{ with $dimensionsData.dimensions }}
    {{ with (index . $src) }}
      {{ $width = .width }}
      {{ $height = .height }}
      {{ $dimensionsFound = true }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $avifResource }}
  {{/* Case A: The .avif file was found */}}
  <img 
    src="{{ $avifResource.RelPermalink }}" 
    alt="{{ $alt }}" 
    class="{{ $class }}" 
    {{ if $dimensionsFound }}
    width="{{ $width }}" 
    height="{{ $height }}"
    {{ end }}
    loading="lazy">
{{ else }}
  {{/* Case B: The .avif file was NOT found, so find the original source image */}}
  {{ $originalResource := .Page.Resources.GetMatch (printf "%s.*" $src) }}
  {{ with $originalResource }}
    {{/* Try to get dimensions safely from original resource */}}
    {{ $originalWidth := "" }}
    {{ $originalHeight := "" }}
    {{ $originalDimensionsFound := false }}
    
    {{ if and (eq .ResourceType "image") (not (in (printf "%T" .) "resourceAdapter")) }}
      {{ $originalWidth = .Width }}
      {{ $originalHeight = .Height }}
      {{ $originalDimensionsFound = true }}
    {{ end }}
    
    <img 
      src="{{ .RelPermalink }}" 
      alt="{{ $alt }}" 
      class="{{ $class }}" 
      {{ if $dimensionsFound }}
      width="{{ $width }}" 
      height="{{ $height }}"
      {{ else if $originalDimensionsFound }}
      width="{{ $originalWidth }}" 
      height="{{ $originalHeight }}"
      {{ end }}
      loading="lazy">
  {{ else }}
    {{/* Case C: Neither the .avif nor an original source image was found */}}
    <p style="color: red;">
      <strong>Image Error:</strong> Could not find any image resource matching '{{ $src }}' in this Page Bundle.
    </p>
  {{ end }}
{{ end }}
