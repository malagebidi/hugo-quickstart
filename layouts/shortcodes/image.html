{{/*
  File: layouts/shortcodes/image.html
  Multi-size AVIF support with responsive images
*/}}
{{ $src := .Get "src" }}
{{ $alt := .Get "alt" | default $src }}
{{ $class := .Get "class" }}
{{ $lazy := .Get "lazy" | default "true" }}

{{/* Extract base name without extension using path functions */}}
{{ $srcBase := path.Base $src }}
{{ $srcExt := path.Ext $srcBase }}
{{ if $srcExt }}
  {{ $srcBase = strings.TrimSuffix $srcBase $srcExt }}
{{ end }}

{{/* Try to get dimensions from hidden dimensions file */}}
{{ $width := "" }}
{{ $height := "" }}
{{ $dimensionsFound := false }}

{{/* Get the directory where this post/page is located */}}
{{ $pagePath := "" }}
{{ with .Page.File }}
  {{ $pagePath = .Dir }}
{{ else }}
  {{/* Fallback for pages without File */}}
  {{ $pagePath = path.Dir .Page.RelPermalink }}
  {{ if eq $pagePath "." }}
    {{ $pagePath = "" }}
  {{ end }}
{{ end }}

{{ $dimensionsFilePath := printf "content/%s.image_dimensions.yaml" $pagePath }}

{{/* Try to read the dimensions file */}}
{{ if fileExists $dimensionsFilePath }}
  {{ $dimensionsContent := readFile $dimensionsFilePath }}
  {{ if $dimensionsContent }}
    {{ $dimensionsData := $dimensionsContent | transform.Unmarshal }}
    {{ with (index $dimensionsData $srcBase) }}
      {{/* Parse the "widthxheight" format */}}
      {{ $dimensionStr := . }}
      {{ $parts := split $dimensionStr "x" }}
      {{ if eq (len $parts) 2 }}
        {{ $width = index $parts 0 }}
        {{ $height = index $parts 1 }}
        {{ $dimensionsFound = true }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Build srcset for different sizes */}}
{{ $srcset := slice }}
{{ $sizes := slice "480" "720" "960" "1440" "1920" "2880" "3840" }}
{{ $availableSizes := slice }}

{{/* Check what AVIF sizes are available */}}
{{ range $sizes }}
  {{ $sizedPath := printf "%s_%sw.avif" $srcBase . }}
  {{ $sizedResource := $.Page.Resources.GetMatch $sizedPath }}
  {{ if $sizedResource }}
    {{ $srcset = $srcset | append (printf "%s %sw" $sizedResource.RelPermalink .) }}
    {{ $availableSizes = $availableSizes | append . }}
  {{ end }}
{{ end }}

{{/* Check if original size AVIF exists (for smaller images) */}}
{{ $originalAvifPath := printf "%s.avif" $srcBase }}
{{ $originalAvifResource := .Page.Resources.GetMatch $originalAvifPath }}

{{/* Determine the main src and largest size */}}
{{ $mainSrc := "" }}
{{ $largestSize := "" }}

{{ if $originalAvifResource }}
  {{/* Use original AVIF as main src */}}
  {{ $mainSrc = $originalAvifResource.RelPermalink }}
  {{ if $dimensionsFound }}
    {{ $largestSize = $width }}
    {{ $srcset = $srcset | append (printf "%s %sw" $originalAvifResource.RelPermalink $width) }}
  {{ end }}
{{ else if gt (len $availableSizes) 0 }}
  {{/* Use largest available size as main src */}}
  {{ $largestAvailableSize := index (last 1 $availableSizes) 0 }}
  {{ $largestPath := printf "%s_%sw.avif" $srcBase $largestAvailableSize }}
  {{ $largestResource := .Page.Resources.GetMatch $largestPath }}
  {{ if $largestResource }}
    {{ $mainSrc = $largestResource.RelPermalink }}
    {{ $largestSize = $largestAvailableSize }}
  {{ end }}
{{ end }}

{{/* If we have AVIF files, render the optimized image */}}
{{ if $mainSrc }}
  <img 
    src="{{ $mainSrc }}" 
    {{ if gt (len $srcset) 0 }}
    srcset="{{ delimit $srcset ", " }}"
    sizes="(max-width: 480px) 480px, (max-width: 720px) 720px, (max-width: 960px) 960px, (max-width: 1440px) 1440px, (max-width: 1920px) 1920px, (max-width: 2880px) 2880px, 3840px"
    {{ end }}
    alt="{{ $alt }}" 
    {{ with $class }}class="{{ . }}" {{ end }}
    {{ if $dimensionsFound }}
    width="{{ $width }}" 
    height="{{ $height }}"
    {{ end }}
    {{ if eq $lazy "true" }}
    loading="lazy"
    {{ end }}>
    
{{ else }}
  {{/* Fallback: try to find original source image */}}
  {{ $originalResource := .Page.Resources.GetMatch (printf "%s.*" $srcBase) }}
  {{ with $originalResource }}
    <img 
      src="{{ .RelPermalink }}" 
      alt="{{ $alt }}" 
      {{ with $class }}class="{{ . }}" {{ end }}
      {{ if $dimensionsFound }}
      width="{{ $width }}" 
      height="{{ $height }}"
      {{ end }}
      {{ if eq $lazy "true" }}
      loading="lazy"
      {{ end }}>
  {{ else }}
    {{/* No images found at all */}}
    <p style="color: red;">
      <strong>Image Error:</strong> Could not find any image resource matching '{{ $src }}' in this Page Bundle.
      <br>Looking for base name: {{ $srcBase }}
      <br>Tried: {{ $originalAvifPath }} and sized AVIF files
      {{ if fileExists $dimensionsFilePath }}
        <br>Dimensions file found at: {{ $dimensionsFilePath }}
        {{ if $dimensionsFound }}
        <br>Dimensions: {{ $width }}x{{ $height }}
        {{ end }}
      {{ else }}
        <br>No dimensions file at: {{ $dimensionsFilePath }}
      {{ end }}
    </p>
  {{ end }}
{{ end }}
