{{/*
  文件: layouts/shortcodes/image.html
  版本: 终极版 (解决 Race Condition)
  功能: 优先寻找并使用 .avif 文件。如果找不到（在第一次构建时），
         则优雅地回退，寻找并使用页面包中的原始图片 (jpg/png/webp)。
*/}}

{{ $src := .Get "src" }}
{{ $alt := .Get "alt" | default $src }}
{{ $class := .Get "class" }}

{{ $avifPath := printf "%s.avif" $src }}
{{ $avifResource := .Page.Resources.GetMatch $avifPath }}

{{ if $avifResource }}
  {{/* 方案A: 找到了 AVIF (第二次构建) */}}
  <img 
    src="{{ $avifResource.RelPermalink }}" 
    alt="{{ $alt }}" 
    class="{{ $class }}" 
    width="{{ $avifResource.Width }}" 
    height="{{ $avifResource.Height }}" 
    loading="lazy">
{{ else }}
  {{/* 方案B: 没找到 AVIF (第一次构建)，尝试寻找原图 */}}
  {{ $originalResource := .Page.Resources.GetMatch (printf "%s.*" $src) }}
  {{ with $originalResource }}
    <img 
      src="{{ .RelPermalink }}" 
      alt="{{ $alt }}" 
      class="{{ $class }}" 
      width="{{ .Width }}" 
      height="{{ .Height }}" 
      loading="lazy">
  {{ else }}
    {{/* 方案C: 连原图都找不到，才真正报错 */}}
    <p style="color: red;">
      <strong>图片错误:</strong> 在此文章包中找不到任何名为 '{{ $src }}' 的图片资源。
    </p>
  {{ end }}
{{ end }}
