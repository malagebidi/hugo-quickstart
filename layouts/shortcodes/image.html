{{/*
  File: layouts/shortcodes/image.html
  Version: Fixed (Adds Resource Type Checking)
  Finds and uses the .avif file if it exists and is an image, otherwise falls back to the original source image.
*/}}
{{ $src := .Get "src" }}
{{ $alt := .Get "alt" | default $src }}
{{ $class := .Get "class" }}
{{ $avifPath := printf "%s.avif" $src }}
{{ $avifResource := .Page.Resources.GetMatch $avifPath }}

{{ if and $avifResource (eq $avifResource.ResourceType "image") }}
  {{/* Case A: The .avif file was found and is an image resource */}}
  <img 
    src="{{ $avifResource.RelPermalink }}" 
    alt="{{ $alt }}" 
    class="{{ $class }}" 
    width="{{ $avifResource.Width }}" 
    height="{{ $avifResource.Height }}" 
    loading="lazy">
{{ else }}
  {{/* Case B: The .avif file was NOT found, so find the original source image */}}
  {{ $originalResource := .Page.Resources.GetMatch (printf "%s.*" $src) }}
  {{ with $originalResource }}
    {{ $hasOriginalImageMethods := false }}
    {{ if reflect.IsMethod . "Width" }}
      {{ $hasOriginalImageMethods = true }}
    {{ end }}
    
    {{ if $hasOriginalImageMethods }}
      <img 
        src="{{ .RelPermalink }}" 
        alt="{{ $alt }}" 
        class="{{ $class }}" 
        width="{{ .Width }}" 
        height="{{ .Height }}" 
        loading="lazy">
    {{ else }}
      <img 
        src="{{ .RelPermalink }}" 
        alt="{{ $alt }}" 
        class="{{ $class }}" 
        loading="lazy">
    {{ end }}
  {{ else }}
    {{/* Case C: Neither the .avif nor an original source image was found */}}
    <p style="color: red;">
      <strong>Image Error:</strong> Could not find any image resource matching '{{ $src }}' in this Page Bundle.
    </p>
  {{ end }}
{{ end }}
