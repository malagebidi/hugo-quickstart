{{/*
  File: layouts/shortcodes/image.html
  Can be used both as shortcode and as partial.
*/}}

{{/* 初始化所有变量 */}}
{{ $src := "" }}
{{ $alt := "" }}
{{ $lazy := "true" }}
{{ $page := "" }}
{{ $type := "content" }} {{/* 默认为内容图片 */}}

{{/* 检测调用方式并设置变量 */}}
{{ if reflect.IsMap . }}
  {{/* 作为 partial 调用时，. 是一个字典 */}}
  {{ $src = index . "src" | default "" }}
  {{ $alt = index . "alt" | default $src }}
  {{ $lazy = index . "lazy" | default "true" }}
  {{ $page = index . "Page" }}
  {{ $type = index . "type" | default "content" }} {{/* partial 调用时可以指定 type */}}
{{ else }}
  {{/* 作为 shortcode 调用时，. 是 shortcode 上下文 */}}
  {{ $src = .Get "src" }}
  {{ $alt = .Get "alt" | default $src }}
  {{ $lazy = .Get "lazy" | default "true" }}
  {{ $page = .Page }}
  {{/* shortcode 调用时默认就是 content，不需要额外参数 */}}
  {{ $type = "content" }}
{{ end }}

{{/* Fallback: Manual string processing */}}
{{ $srcBase := "" }}
{{ if $src }}
  {{ $filename := path.Base $src }}
  
  {{/* 使用 split 和 delimit 方法 */}}
  {{ $parts := split $filename "." }}
  {{ if gt (len $parts) 1 }}
    {{ $srcBase = delimit (first (sub (len $parts) 1) $parts) "." }}
  {{ else }}
    {{ $srcBase = $filename }}
  {{ end }}
{{ end }}

{{/* Try to get dimensions from hidden dimensions file */}}
{{ $width := "" }}
{{ $height := "" }}
{{ $dimensionsFound := false }}

{{/* Get the directory where this post/page is located */}}
{{ $pagePath := "" }}
{{ with $page.File }}
  {{ $pagePath = .Dir }}
{{ else }}
  {{/* Fallback for pages without File */}}
  {{ $pagePath = path.Dir $page.RelPermalink }}
  {{ if eq $pagePath "." }}
    {{ $pagePath = "" }}
  {{ end }}
{{ end }}

{{ $dimensionsFilePath := printf "content/%s.image_dimensions.yaml" $pagePath }}

{{/* Try to read the dimensions file */}}
{{ if fileExists $dimensionsFilePath }}
  {{ $dimensionsContent := readFile $dimensionsFilePath }}
  {{ if $dimensionsContent }}
    {{ $dimensionsData := $dimensionsContent | transform.Unmarshal }}
    {{ with (index $dimensionsData $srcBase) }}
      {{/* Parse the "widthxheight" format */}}
      {{ $dimensionStr := . }}
      {{ $parts := split $dimensionStr "x" }}
      {{ if eq (len $parts) 2 }}
        {{ $width = index $parts 0 }}
        {{ $height = index $parts 1 }}
        {{ $dimensionsFound = true }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* 根据图片类型调整尺寸 */}}
{{ if eq $type "featured" }}
  {{/* 特色图片：强制16:9比例，最大720px */}}
  {{ $width = "720" }}
  {{ $height = "405" }}
  {{ $dimensionsFound = true }}
{{ else if eq $type "content" }}
  {{/* 文章内图片：保持原比例但限制最大宽度720px */}}
  {{ if $dimensionsFound }}
    {{ $originalWidth := int $width }}
    {{ $originalHeight := int $height }}
    {{ if gt $originalWidth 720 }}
      {{ $ratio := div (float $originalHeight) (float $originalWidth) }}
      {{ $width = "720" }}
      {{ $height = printf "%.0f" (mul 720.0 $ratio) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Build srcset for different sizes - 限制最大720px */}}
{{ $srcset := slice }}
{{ $sizes := slice "480" "720" }}
{{ $availableSizes := slice }}
{{ $sizeToUrl := dict }}

{{/* Check what AVIF sizes are available */}}
{{ range $sizes }}
  {{ $sizedPath := printf "%s_%sw.avif" $srcBase . }}
  {{ $sizedResource := $page.Resources.GetMatch $sizedPath }}
  {{ if $sizedResource }}
    {{ $srcset = $srcset | append (printf "%s %sw" $sizedResource.RelPermalink .) }}
    {{ $availableSizes = $availableSizes | append . }}
    {{ $sizeToUrl = merge $sizeToUrl (dict . $sizedResource.RelPermalink) }}
  {{ end }}
{{ end }}

{{/* Check if original size AVIF exists */}}
{{ $originalAvifPath := printf "%s.avif" $srcBase }}
{{ $originalAvifResource := $page.Resources.GetMatch $originalAvifPath }}

{{/* Determine the main src */}}
{{ $mainSrc := "" }}

{{ if $originalAvifResource }}
  {{ $mainSrc = $originalAvifResource.RelPermalink }}
  {{ if $dimensionsFound }}
    {{/* Only add original size if it's not already in the list and not larger than 720px */}}
    {{ $originalWidthInt := int $width }}
    {{ if le $originalWidthInt 720 }}
      {{ $widthInList := false }}
      {{ range $availableSizes }}
        {{ if eq . $width }}
          {{ $widthInList = true }}
          {{ break }}
        {{ end }}
      {{ end }}
      {{ if not $widthInList }}
        {{ $srcset = $srcset | append (printf "%s %sw" $originalAvifResource.RelPermalink $width) }}
        {{ $availableSizes = $availableSizes | append $width }}
        {{ $sizeToUrl = merge $sizeToUrl (dict $width $originalAvifResource.RelPermalink) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ else if gt (len $availableSizes) 0 }}
  {{/* Use largest available size as main src */}}
  {{ $sortedAvailable := sort $availableSizes }}
  {{ $largestAvailableSize := index (last 1 $sortedAvailable) 0 }}
  {{ $mainSrc = index $sizeToUrl $largestAvailableSize }}
{{ end }}

{{/* 生成适配720px限制的sizes属性 */}}
{{ $sizesAttr := "" }}
{{ if gt (len $availableSizes) 0 }}
  {{ $sortedSizes := sort $availableSizes }}
  {{ $sizeRules := slice }}
  
  {{ range $i, $size := $sortedSizes }}
    {{ $sizeInt := int $size }}
    {{ if lt $i (sub (len $sortedSizes) 1) }}
      {{ if le $sizeInt 720 }}
        {{ $sizeRules = $sizeRules | append (printf "(max-width: %spx) %spx" $size $size) }}
      {{ end }}
    {{ end }}
  {{ end }}
  
  {{/* Add the default size, but cap at 720px */}}
  {{ $largestAvailable := index (last 1 $sortedSizes) 0 }}
  {{ $largestInt := int $largestAvailable }}
  {{ if le $largestInt 720 }}
    {{ $sizeRules = $sizeRules | append (printf "%spx" $largestAvailable) }}
  {{ else }}
    {{ $sizeRules = $sizeRules | append "720px" }}
  {{ end }}
  
  {{ $sizesAttr = delimit $sizeRules ", " }}
{{ else }}
  {{/* 默认sizes，限制720px */}}
  {{ $sizesAttr = "(max-width: 480px) 480px, (max-width: 720px) 720px, 720px" }}
{{ end }}

{{/* If we have AVIF files, render the optimized image */}}
{{ if $mainSrc }}
  <img 
    src="{{ $mainSrc }}" 
    {{ if gt (len $srcset) 0 }}
    srcset="{{ delimit $srcset ", " }}"
    {{ if $sizesAttr }}
    sizes="{{ $sizesAttr }}"
    {{ end }}
    {{ end }}
    alt="{{ $alt }}" 
    {{ if $dimensionsFound }}
    width="{{ $width }}" 
    height="{{ $height }}"
    {{ end }}
    {{ if eq $lazy "true" }}
    loading="lazy"
    {{ end }}
    decoding="async">
{{ else }}
  <p style="color: red;">
    <strong>Image Error:</strong> No AVIF found for '{{ $src }}' (base: {{ $srcBase }})
    {{ if fileExists $dimensionsFilePath }}
      <br>Dimensions file: {{ $dimensionsFilePath }}
      {{ if $dimensionsFound }}
      <br>Dimensions: {{ $width }}x{{ $height }}
      {{ end }}
    {{ else }}
      <br>No dimensions file found at: {{ $dimensionsFilePath }}
    {{ end }}
    <br>Available resources: {{ range $page.Resources }}{{ .Name }}, {{ end }}
  </p>
{{ end }}
