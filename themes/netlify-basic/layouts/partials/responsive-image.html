{{/*
  File: layouts/partials/responsive-image.html
  This partial is the central logic for rendering responsive images.
*/}}

{{/* --- FINAL CORRECTED Context & Variable Handling --- */}}
{{ $src := "" }}
{{ $alt := "" }}
{{ $class := "" }}
{{ $lazy := "true" }}
{{ $page := "" }}

{{ if reflect.IsMap . }}
  {{/* PARTIAL call: Data is in a dictionary. */}}
  {{ $src = .src }}
  {{ $alt = .alt }}
  {{ $class = .class | default "" }}
  {{ $lazy = .lazy | default "true" }}
  {{/* THE ABSOLUTE FIX: Explicitly get the page context from the dictionary. */}}
  {{ $page = .Page }} 
{{ else }}
  {{/* SHORTCODE call: Data is accessed via .Get and context is global .Page */}}
  {{ $src = .Get "src" }}
  {{ $alt = .Get "alt" | default $src }}
  {{ $class = .Get "class" }}
  {{ $lazy = .Get "lazy" | default "true" }}
  {{ $page = .Page }}
{{ end }}


{{/* --- Core Image Processing Logic --- */}}

{{/* Ensure src and page context are valid before proceeding */}}
{{ if or (not $src) (not $page) }}
  {{ errorf "Image partial/shortcode requires a 'src' parameter and a valid Page context. Src: '%s', Page: '%v'" $src $page }}
{{ end }}

{{/* Extract base name without extension using path functions */}}
{{ $srcBase := path.BaseName $src }}
{{ $srcExt := path.Ext $src }}
{{ if $srcExt }}
  {{ $srcBase = strings.TrimSuffix $srcBase $srcExt }}
{{ end }}

{{/* Build srcset for different AVIF sizes */}}
{{ $srcset := slice }}
{{ $sizes := slice "480" "720" "960" "1440" "1920" }}
{{ $availableResources := slice }}

{{ range $sizes }}
  {{ $sizedPath := printf "%s_%sw.avif" $srcBase . }}
  {{ with $page.Resources.GetMatch $sizedPath }}
    {{ $srcset = $srcset | append (printf "%s %sw" .RelPermalink .) }}
    {{ $availableResources = $append $availableResources . }}
  {{ end }}
{{ end }}

{{/* Find the original (un-suffixed) AVIF resource to use as the main src */}}
{{ $mainResource := $page.Resources.GetMatch (printf "%s.avif" $srcBase) }}

{{/* If no main resource found, but we have sized versions, pick the largest as fallback */}}
{{ if (and (not $mainResource) (gt (len $availableResources) 0)) }}
  {{ $mainResource = index (last 1 (sort $availableResources "Width" "desc")) 0 }}
{{ end }}


{{/* --- Final HTML Rendering --- */}}
{{ if $mainResource }}
  <img 
    src="{{ $mainResource.RelPermalink }}" 
    {{ with $srcset }}{{ if gt (len .) 0 }}srcset="{{ delimit . ", " | safeHTMLAttr }}"{{ end }}{{ end }}
    sizes="(max-width: {{ $mainResource.Width }}px) 100vw, {{ $mainResource.Width }}px"
    alt="{{ $alt | plainify }}" 
    {{ with $class }}class="{{ . }}"{{ end }}
    width="{{ $mainResource.Width }}" 
    height="{{ $mainResource.Height }}"
    {{ if eq $lazy "true" }}loading="lazy"{{ end }}
    decoding="async">
{{ else }}
  <div style="color: red; background: #fff0f0; border: 1px solid red; padding: 1em; font-family: monospace;">
    <p><strong>Image Partial Error:</strong> Could not find any matching AVIF resources.</p>
    <ul>
      <li><strong>Input 'src':</strong> {{ $src }}</li>
      <li><strong>Calculated Base Name ('$srcBase'):</strong> '{{ $srcBase }}'</li>
      <li><strong>Page Context:</strong> {{ $page.File.Path | default "unknown path" }}</li>
      <li><strong>Checked for (main src):</strong> {{ printf "%s.avif" $srcBase }}</li>
      <li><strong>Checked for (srcset):</strong> {{ printf "%s_*w.avif" $srcBase }}</li>
    </ul>
    <p><strong>Available resources in bundle:</strong></p>
    <pre>{{ range $page.Resources }}{{ .Name }} | {{ end }}</pre>
  </div>
{{ end }}
