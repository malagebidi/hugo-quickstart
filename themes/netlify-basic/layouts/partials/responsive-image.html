{{/*
  Partial: responsive-image.html
  Version: 3.0 - Correctly handles variable scoping.

  Receives a context dictionary with:
  - "context" (required): The page context, usually "$"
  - "resource" (required): The image resource object or filename string
  - "alt" (optional): Alt text
  - "class" (optional): CSS class
  - "lazy" (optional): "true" or "false" for loading attribute
*/}}

{{/* --- 1. Variable Setup --- */}}
{{ $page := .context }}
{{ $resource := .resource }}
{{ $alt := .alt | default $page.Title }}
{{ $class := .class }}
{{ $lazy := .lazy | default "true" }}

{{ $imageResource := "" }}
{{ $srcFilename := "" }}

{{/* --- 2. Smartly handle input: string or resource object --- */}}
{{ if reflect.IsSlice $resource }}
  {{ $imageResource = index $resource 0 }}
{{ else if ne (printf "%T" $resource) "string" }}
  {{ $imageResource = $resource }}
{{ else }}
  {{ $imageResource = $page.Resources.GetMatch $resource }}
{{ end }}

{{/* Ensure we have a resource to work with */}}
{{ if not $imageResource }}
  {{ errorf "Image resource not found for '%v' in page '%s'" .resource $page.File.Path }}
  {{ return }}
{{ end }}
{{ $srcFilename = $imageResource.Name }}


{{/* --- 3. Extract Base Name (The CORRECTED Fix!) --- */}}
{{/* This chain of declarations avoids the scoping issue entirely. */}}
{{ $baseFilename := path.Base $srcFilename }}
{{ $srcExt := path.Ext $baseFilename }}
{{ $srcBase := strings.TrimSuffix $baseFilename $srcExt }}


{{/* Retrieve width and height directly from the original resource */}}
{{ $width := $imageResource.Width }}
{{ $height := $imageResource.Height }}


{{/* --- 4. Build srcset (This section will now work correctly) --- */}}
{{ $srcset := slice }}
{{ $sizes := slice "480" "720" "960" "1440" "1920" "2880" "3840" }}
{{ $availableSizes := slice }}

{{ range $sizes }}
  {{ $sizedPath := printf "%s_%sw.avif" $srcBase . }}
  {{ with $page.Resources.GetMatch $sizedPath }}
    {{ $srcset = $srcset | append (printf "%s %sw" .RelPermalink .) }}
    {{ $availableSizes = $availableSizes | append . }}
  {{ end }}
{{ end }}

{{ with $page.Resources.GetMatch (printf "%s.avif" $srcBase) }}
    {{ $srcset = $srcset | append (printf "%s %sw" .RelPermalink .Width) }}
    {{ $availableSizes = $availableSizes | append (string .Width) }}
{{ end }}

{{ $allSizes := uniq $availableSizes | sort "numeric" }}


{{/* --- 5. Determine main src and generate sizes attribute --- */}}
{{ $mainSrc := "" }}
{{ $sizesAttr := "" }}

{{ if gt (len $allSizes) 0 }}
  {{/* Use the original AVIF if available, otherwise the largest one */}}
  {{ $originalAvifResource := $page.Resources.GetMatch (printf "%s.avif" $srcBase) }}
  {{ if $originalAvifResource }}
    {{ $mainSrc = $originalAvifResource.RelPermalink }}
  {{ else }}
    {{ $largestSize := index (last 1 $allSizes) 0 }}
    {{ $largestPath := printf "%s_%sw.avif" $srcBase $largestSize }}
    {{ with $page.Resources.GetMatch $largestPath }}
      {{ $mainSrc = .RelPermalink }}
    {{ end }}
  {{ end }}
  
  {{/* Build sizes attribute */}}
  {{ $sizeRules := slice }}
  {{ range $i, $size := $allSizes }}
    {{ if lt $i (sub (len $allSizes) 1) }}
      {{ $sizeRules = $sizeRules | append (printf "(max-width: %spx) %spx" $size $size) }}
    {{ end }}
  {{ end }}
  {{ $largestAvailable := index (last 1 $allSizes) 0 }}
  {{ $sizeRules = $sizeRules | append (printf "%spx" $largestAvailable) }}
  {{ $sizesAttr = delimit $sizeRules ", " }}
{{ end }}


{{/* --- 6. Render final HTML --- */}}
{{ if $mainSrc }}
  <img 
    src="{{ $mainSrc }}" 
    srcset="{{ delimit $srcset ", " }}"
    sizes="{{ $sizesAttr }}"
    alt="{{ $alt }}" 
    {{ with $class }}class="{{ . }}"{{ end }}
    width="{{ $width }}" 
    height="{{ $height }}"
    {{ if eq $lazy "true" }}loading="lazy"{{ else }}loading="eager"{{ end }}
    decoding="async">
{{ else }}
  <p style="color: red; background: #fff8f8; border: 1px solid red; padding: 1em;">
    <strong>Image Error:</strong> No AVIF version found for '{{ $srcFilename }}'.<br>
    <strong>Calculated base name:</strong> '{{ $srcBase }}'<br>
    <strong>Page:</strong> {{ $page.File.Path }}<br>
    <strong>Available resources in this bundle:</strong>
    <ul>
      {{ range $page.Resources }}
        <li>{{ .Name }}</li>
      {{ end }}
    </ul>
  </p>
{{ end }}
