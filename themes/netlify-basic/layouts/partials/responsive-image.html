{{/*
  File: layouts/partials/responsive-image.html
  This partial is the central logic for rendering responsive images.
  VERSION: with_debugging
*/}}

{{/* --- DEBUG START --- */}}
{{ warnf "--- BEGIN responsive-image.html Execution ---" }}
{{/* --- DEBUG END --- */}}

{{/* --- Unified Context Handling --- */}}
{{ $src := "" }}
{{ $alt := "" }}
{{ $class := "" }}
{{ $lazy := "true" }}
{{ $page := "" }}

{{ if reflect.IsMap . }}
  {{/* --- DEBUG START --- */}}
  {{ warnf "DEBUG: [Partial] Called as PARTIAL (with a dict)." }}
  {{/* --- DEBUG END --- */}}
  {{ $src = .src }}
  {{ $alt = .alt }}
  {{ $class = .class | default "" }}
  {{ $lazy = .lazy | default "true" }}
  {{ $page = .Page }}
{{ else }}
  {{/* --- DEBUG START --- */}}
  {{ warnf "DEBUG: [Partial] Called as SHORTCODE." }}
  {{/* --- DEBUG END --- */}}
  {{ $src = .Get "src" }}
  {{ $alt = .Get "alt" | default $src }}
  {{ $class = .Get "class" }}
  {{ $lazy = .Get "lazy" | default "true" }}
  {{ $page = .Page }}
{{ end }}

{{/* --- DEBUG START: Inspect initial variables --- */}}
{{ warnf "DEBUG: [Partial] Received src: '%s'" $src }}
{{ warnf "DEBUG: [Partial] Received alt: '%s'" $alt }}
{{ with $page }}{{ warnf "DEBUG: [Partial] Page context is valid for: %s" .File.Path }}{{ else }}{{ warnf "ERROR: [Partial] PAGE CONTEXT IS MISSING!" }}{{ end }}
{{/* --- DEBUG END --- */}}

{{ if not $src }}
  {{ errorf "[Partial] Image partial/shortcode requires a 'src' parameter." }}
{{ end }}

{{ $srcBase := path.Base $src | strings.TrimSuffix (path.Ext $src) }}
{{/* --- DEBUG START --- */}}
{{ warnf "DEBUG: [Partial] Calculated srcBase: '%s'" $srcBase }}
{{/* --- DEBUG END --- */}}

{{/* Try to get dimensions from hidden dimensions file */}}
{{ $width := "" }}
{{ $height := "" }}
{{ $dimensionsFound := false }}
{{ $pagePath := "" }}
{{ with $page.File }}{{ $pagePath = .Dir }}{{ else }}{{ $pagePath = path.Dir $page.RelPermalink }}{{ if eq $pagePath "." }}{{ $pagePath = "" }}{{ end }}{{ end }}
{{ $dimensionsFilePath := printf "content/%s.image_dimensions.yaml" $pagePath }}

{{ if fileExists $dimensionsFilePath }}
  {{ with readFile $dimensionsFilePath | transform.Unmarshal }}
    {{ with (index . $srcBase) }}
      {{ $dimensionStr := . }}
      {{ $parts := split $dimensionStr "x" }}
      {{ if eq (len $parts) 2 }}
        {{ $width = index $parts 0 }}
        {{ $height = index $parts 1 }}
        {{ $dimensionsFound = true }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{/* --- DEBUG START --- */}}
{{ warnf "DEBUG: [Partial] Dimensions file path: '%s'. Found: %v. Dimensions: %sx%s" $dimensionsFilePath (fileExists $dimensionsFilePath) $width $height }}
{{/* --- DEBUG END --- */}}

{{/* Build srcset for different AVIF sizes */}}
{{ $srcset := slice }}
{{ $sizes := slice "480" "720" "960" "1440" "1920" "2880" "3840" }}
{{ $availableSizes := slice }}
{{ $sizeToUrl := dict }}

{{ range $sizes }}
  {{ $sizedPath := printf "%s_%sw.avif" $srcBase . }}
  {{ with $page.Resources.GetMatch $sizedPath }}
    {{ $srcset = $srcset | append (printf "%s %sw" .RelPermalink .) }}
    {{ $availableSizes = $availableSizes | append . }}
    {{ $sizeToUrl = merge $sizeToUrl (dict . .RelPermalink) }}
  {{ end }}
{{ end }}

{{ $originalAvifPath := printf "%s.avif" $srcBase }}
{{ $originalAvifResource := $page.Resources.GetMatch $originalAvifPath }}

{{ $mainSrc := "" }}

{{ if $originalAvifResource }}
  {{ $mainSrc = $originalAvifResource.RelPermalink }}
  {{ if $dimensionsFound }}
    {{ if not (in $availableSizes $width) }}
      {{ $srcset = $srcset | append (printf "%s %sw" .RelPermalink $width) }}
      {{ $availableSizes = $availableSizes | append $width }}
      {{ $sizeToUrl = merge $sizeToUrl (dict $width .RelPermalink) }}
    {{ end }}
  {{ end }}
{{ else if gt (len $availableSizes) 0 }}
  {{ $sortedAvailable := sort $availableSizes }}
  {{ $largestAvailableSize := index (last 1 $sortedAvailable) 0 }}
  {{ $mainSrc = index $sizeToUrl $largestAvailableSize }}
{{ end }}

{{/* Generate dynamic sizes attribute based on available sizes */}}
{{ $sizesAttr := "" }}
{{ if gt (len $availableSizes) 0 }}
  {{ $sortedSizes := sort $availableSizes }}
  {{ $sizeRules := slice }}
  {{ range $i, $size := $sortedSizes }}
    {{ if lt $i (sub (len $sortedSizes) 1) }}
      {{ $sizeRules = $sizeRules | append (printf "(max-width: %spx) %spx" $size $size) }}
    {{ end }}
  {{ end }}
  {{ $largestAvailable := index (last 1 $sortedSizes) 0 }}
  {{ $sizeRules = $sizeRules | append (printf "%spx" $largestAvailable) }}
  {{ $sizesAttr = delimit $sizeRules ", " }}
{{ end }}

{{/* --- DEBUG START: Inspect final variables before rendering --- */}}
{{ warnf "DEBUG: [Partial] AVIF resources found for base '%s': %d sizes. Original AVIF found: %v" $srcBase (len $availableSizes) (not (not $originalAvifResource)) }}
{{ warnf "DEBUG: [Partial] Final mainSrc: '%s'" $mainSrc }}
{{ warnf "DEBUG: [Partial] Final srcset contains %d items: %s" (len $srcset) (delimit $srcset " | ") }}
{{/* --- DEBUG END --- */}}

{{/* --- Final HTML Rendering --- */}}
{{ if $mainSrc }}
  {{/* --- DEBUG START --- */}}
  {{ warnf "SUCCESS: [Partial] mainSrc is valid. Rendering <img> tag now." }}
  {{/* --- DEBUG END --- */}}
  <img 
    src="{{ $mainSrc }}" 
    {{ with $srcset }}{{ if gt (len .) 0 }}srcset="{{ delimit . ", " }}"{{ end }}{{ end }}
    {{ with $sizesAttr }}sizes="{{ . }}"{{ end }}
    alt="{{ $alt }}" 
    {{ with $class }}class="{{ . }}" {{ end }}
    {{ if $dimensionsFound }}
    width="{{ $width }}" 
    height="{{ $height }}"
    {{ end }}
    {{ if eq $lazy "true" }}loading="lazy"{{ end }}
    decoding="async">
{{ else }}
  {{/* --- DEBUG START --- */}}
  {{ warnf "ERROR: [Partial] 'mainSrc' is EMPTY. Cannot render <img>. No matching AVIF resources were found for base '%s' in page '%s'." $srcBase $page.File.Path }}
  {{/* --- DEBUG END --- */}}
  <p style="color: red; border: 1px solid red; padding: 10px; background-color: #ffeeee;">
    <strong>Image Render Error:</strong> No AVIF resources were found for '<strong>{{ $src }}</strong>' (base name: '<strong>{{ $srcBase }}</strong>').
    <br>Page Context: <strong>{{ $page.File.Path }}</strong>
    <br>Searched for AVIFs like: <strong>{{ $srcBase }}.avif</strong>, <strong>{{ $srcBase }}_480w.avif</strong>, etc.
    <br>Available Resources in this Page Bundle:
    <ul style="margin-top: 5px;">
      {{ range $page.Resources }}
        <li>{{ .Name }} ({{ .MediaType }})</li>
      {{ else }}
        <li>No resources found in this page bundle.</li>
      {{ end }}
    </ul>
  </p>
{{ end }}

{{/* --- DEBUG START --- */}}
{{ warnf "--- END responsive-image.html Execution ---\n" }}
{{/* --- DEBUG END --- */}}
