{{/*
  Partial: responsive-image.html
  Version: 4.0 - Bulletproof Edition. Robust error handling and clear logic.

  Receives a context dictionary:
  - "context" (required): The page context, usually "$"
  - "src" (required): The original image filename string (e.g., "ff-cotw.jpg")
  - "alt" (optional): Alt text
  - "class" (optional): CSS class
  - "lazy" (optional): "true" or "false"
*/}}

{{/* --- 1. Variable Setup & Validation --- */}}
{{ $page := .context }}
{{ $srcFilename := .src }}
{{ $alt := .alt | default $page.Title }}
{{ $class := .class }}
{{ $lazy := .lazy | default "true" }}

{{ if not $srcFilename }}
  {{/* If no src is passed, silently do nothing. Or uncomment errorf for strict mode. */}}
  {{/* {{ errorf "Partial 'responsive-image.html' was called without a 'src' parameter on page %s" $page.File.Path }} */}}
  {{ return }}
{{ end }}


{{/* --- 2. Find the Original Image Resource --- */}}
{{/* We ONLY search for the original (non-AVIF, non-resized) image here. */}}
{{ $originalImageResource := $page.Resources.GetMatch $srcFilename }}

{{/* --- 3. THE CRITICAL CHECK --- */}}
{{/* If the original source image (e.g., .jpg, .png) doesn't exist, we stop immediately. */}}
{{ if not $originalImageResource }}
  <p style="color: red; background: #fff8f8; border: 1px solid red; padding: 1em;">
    <strong>Image Error:</strong> The source image '<code>{{ $srcFilename }}</code>' could not be found in the resources for page '<code>{{ $page.File.Path }}</code>'. Please check the filename and ensure it's part of the page bundle.
  </p>
  {{ return }} {{/* Stop all further execution */}}
{{ end }}


{{/* --- 4. If we are here, the resource exists. Safely extract info. --- */}}
{{ $baseFilename := path.Base $srcFilename }}
{{ $srcExt := path.Ext $baseFilename }}
{{ $srcBase := strings.TrimSuffix $baseFilename $srcExt }}
{{ $width := $originalImageResource.Width }}
{{ $height := $originalImageResource.Height }}


{{/* --- 5. Build srcset with AVIF versions --- */}}
{{ $srcset := slice }}
{{ $sizes := slice "480" "720" "960" "1440" "1920" "2880" "3840" }}
{{ $availableWidths := slice }}

{{/* Find resized AVIF versions */}}
{{ range $sizes }}
  {{ $sizedPath := printf "%s_%sw.avif" $srcBase . }}
  {{ with $page.Resources.GetMatch $sizedPath }}
    {{ $srcset = $srcset | append (printf "%s %sw" .RelPermalink .) }}
    {{ $availableWidths = $availableWidths | append . }}
  {{ end }}
{{ end }}

{{/* Find the original-size AVIF version */}}
{{ with $page.Resources.GetMatch (printf "%s.avif" $srcBase) }}
  {{ $srcset = $srcset | append (printf "%s %sw" .RelPermalink .Width) }}
  {{ $availableWidths = $availableWidths | append (string .Width) }}
{{ end }}


{{/* --- 6. Determine Main Src and Final Attributes --- */}}
{{ $mainSrc := "" }}
{{ $sizesAttr := "" }}
{{ $sortedWidths := $availableWidths | uniq | sort "numeric" }}
{{ $originalAvifResource := $page.Resources.GetMatch (printf "%s.avif" $srcBase) }}

{{/* Prefer the original-size AVIF as src, fallback to the largest available resized AVIF */}}
{{ if $originalAvifResource }}
  {{ $mainSrc = $originalAvifResource.RelPermalink }}
{{ else if gt (len $sortedWidths) 0 }}
  {{ $largestWidth := index (last 1 $sortedWidths) 0 }}
  {{ with $page.Resources.GetMatch (printf "%s_%sw.avif" $srcBase $largestWidth) }}
    {{ $mainSrc = .RelPermalink }}
  {{ end }}
{{ end }}

{{/* Build the 'sizes' attribute */}}
{{ if gt (len $sortedWidths) 0 }}
  {{ $sizeRules := slice }}
  {{ range $i, $width := $sortedWidths }}
    {{ if lt $i (sub (len $sortedWidths) 1) }}
      {{ $sizeRules = $sizeRules | append (printf "(max-width: %spx) %spx" $width $width) }}
    {{ else }}
      {{ $sizeRules = $sizeRules | append (printf "%spx" $width) }}
    {{ end }}
  {{ end }}
  {{ $sizesAttr = delimit $sizeRules ", " }}
{{ end }}


{{/* --- 7. Render Final HTML --- */}}
{{ if $mainSrc }}
  <img 
    src="{{ $mainSrc }}" 
    srcset="{{ delimit $srcset ", " }}"
    sizes="{{ $sizesAttr }}"
    alt="{{ $alt }}" 
    {{ with $class }}class="{{ . }}"{{ end }}
    width="{{ $width }}" 
    height="{{ $height }}"
    {{ if eq $lazy "true" }}loading="lazy"{{ else }}loading="eager"{{ end }}
    decoding="async">
{{ else }}
  {{/* This fallback shows the original JPG/PNG if no AVIF is found at all */}}
  <img 
    src="{{ $originalImageResource.RelPermalink }}"
    alt="{{ $alt }}"
    {{ with $class }}class="{{ . }}"{{ end }}
    width="{{ $width }}" 
    height="{{ $height }}"
    {{ if eq $lazy "true" }}loading="lazy"{{ else }}loading="eager"{{ end }}
    decoding="async">
{{ end }}

